- name: Create users with git config add ssh keys
  hosts: appservers
  become: yes

  vars:
    users:
      - { name: jaime, shell: /bin/zsh }
      - { name: sansa, shell: /bin/zsh }
      - { name: robert, shell: /bin/bash }

  tasks:
    - name: Create users
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: "{{ item.shell }}"
        state: present
        create_home: yes
      loop: "{{ users }}"

    - name: Create .ssh directory
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ users }}"

    - name: Copy authorized_keys
      copy:
        src: id_rsa.pub
        dest: "/home/{{ item.name }}/.ssh/authorized_keys"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0600'
      loop: "{{ users }}"

    - name: Create .gitconfig with user-specific email and name
      copy:
        dest: "/home/{{ item.name }}/.gitconfig"
        content: |
          [alias]
            co = checkout
            ci = commit
            st = status
            br = branch
            hist = log --pretty=format:'%h %ad | %s%d [%an]' --graph --date=short
            type = cat-file -t
            dump = cat-file -p
            commend = commit --amend
          [core]
            excludesFile = ~/.gitignore_global
            editor = vim
          [user]
            email = {{ item.name }}@test.com
            name = {{ item.name }}
          [credential]
            helper = store
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0600'
      loop: "{{ users }}"